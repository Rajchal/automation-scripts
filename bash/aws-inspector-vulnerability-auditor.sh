#!/bin/bash

################################################################################
# AWS Inspector Vulnerability Auditor
# Scans EC2 instances and container images for security vulnerabilities,
# generates detailed reports, and prioritizes findings by severity and impact
################################################################################

set -euo pipefail

# Configuration
REGION="${AWS_REGION:-us-east-1}"
OUTPUT_FILE="/tmp/inspector-audit-$(date +%s).txt"
LOG_FILE="${LOG_FILE:-/var/log/inspector-audit.log}"
SLACK_WEBHOOK="${SLACK_WEBHOOK:-}"
EMAIL_TO="${EMAIL_TO:-}"

# Severity thresholds
CRITICAL_THRESHOLD="${CRITICAL_THRESHOLD:-1}"     # alert if >= this many CRITICAL
HIGH_THRESHOLD="${HIGH_THRESHOLD:-5}"              # alert if >= this many HIGH
MEDIUM_THRESHOLD="${MEDIUM_THRESHOLD:-10}"        # alert if >= this many MEDIUM

# Scanning
AUTO_SCAN="${AUTO_SCAN:-false}"                   # enable auto-scanning
SCAN_TIMEOUT="${SCAN_TIMEOUT:-3600}"              # seconds to wait for scan completion

# Color codes
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
NC='\033[0m'

# Logging
log_message() {
  local level="$1"; shift
  local msg="$@"
  local ts
  ts=$(date '+%Y-%m-%dT%H:%M:%S')
  echo "[${ts}] [${level}] ${msg}" | tee -a "${LOG_FILE}"
}

# Helpers
jq_safe() { jq -r "$1" 2>/dev/null || echo ""; }

list_findings() {
  local filter_criteria="$1"
  aws inspector2 list-findings \
    --filter-criteria "${filter_criteria}" \
    --region "${REGION}" \
    --output json 2>/dev/null || echo '{"findings":[]}'
}

get_findings_paginated() {
  local severity="$1"
  local next_token=""
  local all_findings=()
  
  while true; do
    local cmd="aws inspector2 list-findings --region ${REGION} --output json"
    
    # Add filter for severity if provided
    if [[ -n "${severity}" && "${severity}" != "ALL" ]]; then
      cmd="${cmd} --filter-criteria '{\"severities\":[{\"comparison\":\"EQUALS\",\"value\":\"${severity}\"}]}'"
    fi
    
    if [[ -n "${next_token}" ]]; then
      cmd="${cmd} --next-token '${next_token}'"
    fi
    
    local result
    result=$(eval "${cmd}" 2>/dev/null || echo '{"findings":[]}')
    
    local findings
    findings=$(echo "${result}" | jq -r '.findings[]?' 2>/dev/null)
    
    if [[ -n "${findings}" ]]; then
      while IFS= read -r finding; do
        [[ -z "${finding}" ]] && continue
        all_findings+=("${finding}")
      done <<< "${findings}"
    fi
    
    next_token=$(echo "${result}" | jq_safe '.nextToken')
    if [[ -z "${next_token}" || "${next_token}" == "null" ]]; then
      break
    fi
  done
  
  printf '%s\n' "${all_findings[@]}"
}

describe_finding() {
  local finding_arn="$1"
  aws inspector2 get-finding \
    --finding-arn "${finding_arn}" \
    --region "${REGION}" \
    --output json 2>/dev/null || echo '{}'
}

list_ec2_instances() {
  aws ec2 describe-instances \
    --region "${REGION}" \
    --query 'Reservations[*].Instances[*].[InstanceId,State.Name,Tags[?Key==`Name`].Value|[0]]' \
    --output json 2>/dev/null || echo '[]'
}

send_slack_alert() {
  local message="$1"
  local severity="$2"
  
  if [[ -z "${SLACK_WEBHOOK}" ]]; then
    return
  fi
  
  local color
  case "${severity}" in
    CRITICAL) color="danger" ;;
    HIGH)     color="warning" ;;
    MEDIUM)   color="accent" ;;
    INFO)     color="good" ;;
    *)        color="good" ;;
  esac
  
  local payload
  payload=$(cat <<EOF
{
  "attachments": [
    {
      "color": "${color}",
      "title": "Inspector Vulnerability Alert",
      "text": "${message}",
      "ts": $(date +%s)
    }
  ]
}
EOF
)
  
  curl -X POST -H 'Content-type: application/json' \
    --data "${payload}" \
    "${SLACK_WEBHOOK}" 2>/dev/null || true
}

send_email_alert() {
  local subject="$1"
  local body="$2"
  
  if [[ -z "${EMAIL_TO}" ]] || ! command -v mail &>/dev/null; then
    return
  fi
  
  echo "${body}" | mail -s "${subject}" "${EMAIL_TO}" 2>/dev/null || true
}

write_header() {
  {
    echo "AWS Inspector Vulnerability Audit Report"
    echo "========================================"
    echo "Generated: $(date)"
    echo "Region: ${REGION}"
    echo "Auto-Scan: ${AUTO_SCAN}"
    echo ""
    echo "Alert Thresholds:"
    echo "  CRITICAL: >= ${CRITICAL_THRESHOLD}"
    echo "  HIGH: >= ${HIGH_THRESHOLD}"
    echo "  MEDIUM: >= ${MEDIUM_THRESHOLD}"
    echo ""
  } > "${OUTPUT_FILE}"
}

audit_findings() {
  log_message INFO "Starting vulnerability audit"
  
  {
    echo "=== VULNERABILITY FINDINGS ==="
    echo ""
  } >> "${OUTPUT_FILE}"
  
  local total_findings=0
  local critical_count=0
  local high_count=0
  local medium_count=0
  local low_count=0
  local informational_count=0
  
  # Collect findings by severity
  for severity in CRITICAL HIGH MEDIUM LOW INFORMATIONAL; do
    log_message INFO "Scanning for ${severity} findings"
    
    local findings
    findings=$(get_findings_paginated "${severity}")
    
    if [[ -z "${findings}" ]]; then
      continue
    fi
    
    while IFS= read -r finding_arn; do
      [[ -z "${finding_arn}" ]] && continue
      ((total_findings++))
      
      case "${severity}" in
        CRITICAL)       ((critical_count++)) ;;
        HIGH)           ((high_count++)) ;;
        MEDIUM)         ((medium_count++)) ;;
        LOW)            ((low_count++)) ;;
        INFORMATIONAL)  ((informational_count++)) ;;
      esac
    done <<< "${findings}"
  done
  
  {
    echo "Summary:"
    printf "%bCRITICAL: %d%b\n" "${RED}" "${critical_count}" "${NC}"
    printf "%bHIGH: %d%b\n" "${YELLOW}" "${high_count}" "${NC}"
    printf "%bMEDIUM: %d%b\n" "${BLUE}" "${medium_count}" "${NC}"
    printf "%bLOW: %d%b\n" "${GREEN}" "${low_count}" "${NC}"
    echo "INFORMATIONAL: ${informational_count}"
    echo "TOTAL: ${total_findings}"
    echo ""
  } >> "${OUTPUT_FILE}"
  
  # Detailed findings by severity
  {
    echo "=== CRITICAL FINDINGS ==="
    echo ""
  } >> "${OUTPUT_FILE}"
  
  local critical_findings
  critical_findings=$(get_findings_paginated "CRITICAL")
  
  if [[ -n "${critical_findings}" ]]; then
    echo "${critical_findings}" | head -10 | while IFS= read -r finding_arn; do
      [[ -z "${finding_arn}" ]] && continue
      
      local finding_desc
      finding_desc=$(describe_finding "${finding_arn}")
      
      local resource_id resource_type title description severity cve_id
      resource_id=$(echo "${finding_desc}" | jq_safe '.finding.resources[0].id')
      resource_type=$(echo "${finding_desc}" | jq_safe '.finding.resources[0].type')
      title=$(echo "${finding_desc}" | jq_safe '.finding.title')
      description=$(echo "${finding_desc}" | jq_safe '.finding.description')
      severity=$(echo "${finding_desc}" | jq_safe '.finding.severity')
      cve_id=$(echo "${finding_desc}" | jq_safe '.finding.packageVulnerabilityDetails.vulnerabilityId // "N/A"')
      
      {
        echo "Resource: ${resource_id} (${resource_type})"
        echo "Title: ${title}"
        echo "Severity: ${severity}"
        if [[ "${cve_id}" != "N/A" ]]; then
          echo "CVE ID: ${cve_id}"
        fi
        echo "Description: ${description:0:150}..."
        echo ""
      } >> "${OUTPUT_FILE}"
      
    done
  else
    {
      echo "No critical findings"
      echo ""
    } >> "${OUTPUT_FILE}"
  fi
  
  # HIGH findings
  {
    echo "=== HIGH FINDINGS ==="
    echo ""
  } >> "${OUTPUT_FILE}"
  
  local high_findings
  high_findings=$(get_findings_paginated "HIGH")
  
  if [[ -n "${high_findings}" ]]; then
    echo "${high_findings}" | head -10 | while IFS= read -r finding_arn; do
      [[ -z "${finding_arn}" ]] && continue
      
      local finding_desc
      finding_desc=$(describe_finding "${finding_arn}")
      
      local resource_id title severity cve_id
      resource_id=$(echo "${finding_desc}" | jq_safe '.finding.resources[0].id')
      title=$(echo "${finding_desc}" | jq_safe '.finding.title')
      severity=$(echo "${finding_desc}" | jq_safe '.finding.severity')
      cve_id=$(echo "${finding_desc}" | jq_safe '.finding.packageVulnerabilityDetails.vulnerabilityId // "N/A"')
      
      {
        echo "Resource: ${resource_id}"
        echo "Title: ${title}"
        if [[ "${cve_id}" != "N/A" ]]; then
          echo "CVE ID: ${cve_id}"
        fi
        echo ""
      } >> "${OUTPUT_FILE}"
      
    done
  else
    {
      echo "No high findings"
      echo ""
    } >> "${OUTPUT_FILE}"
  fi
  
  # Alerts
  if [[ ${critical_count} -ge ${CRITICAL_THRESHOLD} ]]; then
    log_message CRITICAL "Found ${critical_count} CRITICAL vulnerabilities"
    local alert_msg="ðŸ”´ CRITICAL: ${critical_count} critical security vulnerabilities detected!"
    send_slack_alert "${alert_msg}" "CRITICAL"
    send_email_alert "Inspector Alert: Critical Vulnerabilities Found" "${alert_msg}"
  fi
  
  if [[ ${high_count} -ge ${HIGH_THRESHOLD} ]]; then
    log_message WARN "Found ${high_count} HIGH vulnerabilities"
    local alert_msg="âš ï¸  WARNING: ${high_count} high severity vulnerabilities detected"
    send_slack_alert "${alert_msg}" "HIGH"
  fi
  
  if [[ ${medium_count} -ge ${MEDIUM_THRESHOLD} ]]; then
    log_message WARN "Found ${medium_count} MEDIUM vulnerabilities"
    local alert_msg="â„¹ï¸  INFO: ${medium_count} medium severity vulnerabilities detected"
    send_slack_alert "${alert_msg}" "MEDIUM"
  fi
  
  log_message INFO "Audit complete. Total: ${total_findings}, Critical: ${critical_count}, High: ${high_count}"
}

list_affected_resources() {
  log_message INFO "Identifying affected resources"
  
  {
    echo ""
    echo "=== AFFECTED RESOURCES ==="
    echo ""
  } >> "${OUTPUT_FILE}"
  
  local instances_json
  instances_json=$(list_ec2_instances)
  
  local instance_count=0
  echo "${instances_json}" | jq -r '.[][] | @csv' 2>/dev/null | while IFS=',' read -r instance_id state name; do
    instance_id=$(echo "${instance_id}" | tr -d '"')
    state=$(echo "${state}" | tr -d '"')
    name=$(echo "${name}" | tr -d '"')
    
    # Check for findings on this instance
    local instance_findings
    instance_findings=$(get_findings_paginated "ALL" | grep -i "${instance_id}" || echo "")
    
    if [[ -n "${instance_findings}" ]]; then
      local finding_count
      finding_count=$(echo "${instance_findings}" | wc -l)
      
      printf "Instance: %-30s State: %-10s Findings: %d\n" "${name}" "${state}" "${finding_count}" >> "${OUTPUT_FILE}"
      ((instance_count++))
    fi
  done
  
  {
    echo ""
    echo "Total affected instances: ${instance_count}"
    echo ""
  } >> "${OUTPUT_FILE}"
}

remediation_guidance() {
  {
    echo ""
    echo "=== REMEDIATION GUIDANCE ==="
    echo ""
    echo "Critical Findings:"
    echo "  â€¢ Patch immediately or isolate affected resources"
    echo "  â€¢ Review security group rules and restrict access"
    echo "  â€¢ Consider terminating unpatched instances"
    echo ""
    echo "High Findings:"
    echo "  â€¢ Schedule patching within 7 days"
    echo "  â€¢ Review vulnerability impact and exploitability"
    echo "  â€¢ Test patches in non-production environment first"
    echo ""
    echo "Medium Findings:"
    echo "  â€¢ Schedule patching within 30 days"
    echo "  â€¢ Review mitigations and workarounds"
    echo "  â€¢ Plan patch management schedule"
    echo ""
    echo "General Recommendations:"
    echo "  â€¢ Enable EC2 Instance Metadata Service v2 (IMDSv2)"
    echo "  â€¢ Use Systems Manager Session Manager instead of SSH"
    echo "  â€¢ Enable automatic patching with Systems Manager Patch Manager"
    echo "  â€¢ Scan container images in ECR with Amazon Inspector"
    echo "  â€¢ Implement least privilege IAM roles"
    echo "  â€¢ Use security groups to restrict network access"
    echo "  â€¢ Monitor CloudTrail for unauthorized access attempts"
    echo "  â€¢ Enable GuardDuty for threat detection"
    echo ""
  } >> "${OUTPUT_FILE}"
}

main() {
  log_message INFO "=== Inspector Vulnerability Audit Started ==="
  
  write_header
  audit_findings
  list_affected_resources
  remediation_guidance
  
  {
    echo ""
    echo "Report saved to: ${OUTPUT_FILE}"
    echo "Log file: ${LOG_FILE}"
    echo ""
    echo "View findings in AWS Console:"
    echo "  https://console.aws.amazon.com/inspector/home?region=${REGION}#/findings"
  } >> "${OUTPUT_FILE}"
  
  cat "${OUTPUT_FILE}"
  
  log_message INFO "=== Inspector Vulnerability Audit Completed ==="
}

main "$@"
